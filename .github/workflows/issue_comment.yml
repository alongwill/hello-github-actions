#
# Goal: Can we run a workflow on the branch the PR was created with?
#
name: Invoke PR comment Workflow

on:
  issue_comment:
    types:
      - created
    # branches:
    #   - master
    #   - main 
    #   - develop

jobs:
  invoke-pr-comment-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Work out branch we are on
        id: branch
        run: |
          REF=$(gh pr view ${{ github.event.issue.number }} -R Busuu/${GITHUB_REPOSITORY##*/} --json headRefName -q '.headRefName')
          echo "branch_name=${REF}" >> ${GITHUB_ENV}
        env:
         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug values
        run: |
          echo "branch_ref   = $branch_name (from gh cli)"
          echo "branch       = ${GITHUB_REF##*/} (from GITHUB_REF)"
          echo "issue_number = ${{ github.event.issue.number }}"
      - name: Invoke shared Ephemeral Workflow
        uses: actions/github-script@v6
        env:
          branch_ref: ${{ env.branch_name }}
        with:
          script: |-
            github.issues.createComment({
              issue_number: '${{ github.event.issue.number }}',
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Action succeeded! âœ… ',
            });  
      - name: Dump GitHub context to use for local testing
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"   